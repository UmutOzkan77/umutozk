<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AGEN Fiyat Teklifi Formu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Favicon -->
    <link rel="icon" href="icon.png" type="image/png">
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Include html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <!-- Include Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary-color: #0563C1;
            --secondary-color: #00AEEF;
            --background-color: #f0f8ff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --button-color: #00AEEF;
            --delete-button-color: #ff6b6b;
            --apply-all-button-color: #ffa502; /* Yeni renk */
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .quick-fill-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-fill-button {
            flex: 1;
            padding: 10px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .quick-fill-button:hover {
            background-color: #0086bb;
        }

        /* Mobil için ürün bölümü */
        .product-section {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .product-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .product-number {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .reorder-buttons {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .reorder-buttons button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .reorder-buttons button:hover {
            background-color: #004a99;
        }

        .currency-input {
            display: flex;
            align-items: center;
        }

        .currency-input input {
            flex-grow: 1;
            margin-right: 5px;
        }

        .currency-input select {
            width: auto;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background-color: var(--button-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #0086bb;
        }

        .delete-button {
            background-color: var(--delete-button-color);
        }

        .delete-button:hover {
            background-color: #ff4757;
        }

        .pdf-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .pdf-button {
            padding: 12px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }

        .pdf-print {
            background-color: var(--primary-color);
        }

        .pdf-download {
            background-color: #ffa502;
        }

        .pdf-share {
            background-color: #4caf50;
        }

        /* Yeni Sütun Ekleme Stilleri */
        .extra-columns {
            margin-bottom: 20px;
        }

        .extra-columns .extra-column-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .extra-columns button {
            background-color: var(--button-color);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
            transition: background-color 0.3s;
        }

        .extra-columns button:hover {
            background-color: #0086bb;
        }

        .extra-column {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .extra-column input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .extra-column button {
            margin-right: 5px;
        }

        .extra-column .fill-column-button {
            background-color: var(--apply-all-button-color); /* Yeni renk */
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 5px;
            transition: background-color 0.3s;
        }

        .extra-column .fill-column-button:hover {
            background-color: #e08902;
        }

        .extra-column .delete-extra-column {
            background-color: var(--delete-button-color);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .extra-column .delete-extra-column:hover {
            background-color: #ff4757;
        }

        /* Masaüstü için tablo stili */
        @media (min-width: 601px) {
            /* Ürün bölümü gizle */
            .product-section {
                display: none;
            }

            /* Tablo stili */
            #productTable {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            #productTable th, #productTable td {
                border: 1px solid var(--border-color);
                padding: 10px;
                text-align: left;
                font-size: 14px;
            }

            #productTable th {
                background-color: var(--primary-color);
                color: white;
            }

            .action-button {
                width: auto;
                margin-top: 0;
            }

            .actions-cell button {
                margin-right: 5px;
            }

            .actions-cell .delete-button {
                margin-top: 5px;
            }
        }

        /* Mobil için tablo gizle */
        @media (max-width: 600px) {
            #productTable {
                display: none;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>AGEN Fiyat Teklifi Formu</h1>

        <div class="form-group">
            <label for="alici">Alıcı:</label>
            <input type="text" id="alici" placeholder="Alıcı adını girin" required>
        </div>

        <div class="form-group">
            <label for="ilgili">İlgili:</label>
            <input type="text" id="ilgili" placeholder="İlgili kişinin adını girin" required>
        </div>

        <div class="form-group">
            <label for="gonderen">Gönderen:</label>
            <input type="text" id="gonderen" placeholder="Gönderen kişinin adını girin" required>
        </div>

        <div class="quick-fill-buttons">
            <button class="quick-fill-button" onclick="fillSender('Mustafa GÜR')">Mustafa GÜR</button>
            <button class="quick-fill-button" onclick="fillSender('Uğurcan TAMAŞ')">Uğurcan TAMAŞ</button>
        </div>

        <div class="form-group">
            <label for="tarih">Tarih:</label>
            <input type="date" id="tarih" required>
        </div>

        <div class="form-group">
            <label for="teklifNo">Teklif No:</label>
            <input type="text" id="teklifNo" placeholder="Teklif numarasını girin" required>
        </div>

        <div class="form-group">
            <label for="genelToplamCurrency">Genel Toplam Para Birimi:</label>
            <select id="genelToplamCurrency">
                <option value="EUR">€</option>
                <option value="TRY">₺</option>
                <option value="USD">$</option>
            </select>
        </div>

        <!-- Yeni Sütun Ekleme Bölümü -->
        <div class="extra-columns">
            <div class="extra-column-buttons">
                <button onclick="addExtraColumn('Marka')">Marka Sütunu Ekle</button>
                <button onclick="addExtraColumn('Termin')">Termin Sütunu Ekle</button>
                <button onclick="promptExtraColumn()">Yeni Sütun Ekle</button>
            </div>
            <div id="extraColumnsContainer">
                <!-- Ekstra sütunlar buraya eklenecek -->
            </div>
        </div>

        <!-- Masaüstü için ürün tablosu -->
        <table id="productTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ürün İsmi</th>
                    <th>Adet</th>
                    <th>Birim Fiyatı</th>
                    <th>Toplam Fiyat</th>
                    <!-- Ekstra sütun başlıkları buraya eklenecek -->
                    <th class="actions-column">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                <!-- Ürün satırları buraya eklenecek -->
            </tbody>
        </table>

        <!-- Mobil için ürün bölümleri -->
        <div id="productContainer">
            <!-- Ürün bölümleri buraya eklenecek -->
        </div>

        <button class="action-button" onclick="addProduct()">Yeni Ürün Ekle</button>

        <div class="pdf-buttons">
            <button class="pdf-button pdf-print" onclick="generatePDF()">PDF Çıktısı Al</button>
            <button class="pdf-button pdf-download" onclick="downloadPDF()">PDF Olarak İndir</button>
            <button class="pdf-button pdf-share" onclick="sharePDF()">PDF Olarak Paylaş</button>
        </div>
    </div>

    <script>
        // Tarihi otomatik ayarla
        document.getElementById('tarih').valueAsDate = new Date();

        // Sayfa yüklendiğinde ilk ürünü ve "Stok Durumu" sütununu ekle
        window.onload = function() {
            addProduct();
            addExtraColumn('Stok Durumu');
        };

        // Gönderen alanını doldurmak için fonksiyon
        function fillSender(name) {
            document.getElementById('gonderen').value = name;
        }

        // Döviz Kuru API Anahtarı
        const API_KEY = 'e7bbdab4e92cef5b5dfd1682';

        // Döviz kurları
        let exchangeRates = {};

        // Ekstra sütunları saklamak için dizi
        let extraColumns = [];

        // Döviz kurlarını API'den çek
        async function fetchExchangeRates(baseCurrency) {
            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/${baseCurrency}`);
                const data = await response.json();
                if (data.result === 'success') {
                    exchangeRates = data.conversion_rates;
                } else {
                    alert('Döviz kurları alınamadı. Lütfen API anahtarınızı kontrol edin.');
                }
            } catch (error) {
                alert('Döviz kurları alınırken bir hata oluştu.');
            }
        }

        function promptExtraColumn() {
            const columnName = prompt("Lütfen eklemek istediğiniz sütun adını girin:");
            if (columnName) {
                addExtraColumn(columnName);
            }
        }

        function addExtraColumn(columnName) {
            if (extraColumns.includes(columnName)) {
                alert(`${columnName} sütunu zaten eklenmiş.`);
                return;
            }

            // Ekstra sütunları güncelle
            extraColumns.push(columnName);

            // Ekstra sütunlar bölümüne ekle
            const extraColumnsContainer = document.getElementById('extraColumnsContainer');

            const extraColumnDiv = document.createElement('div');
            extraColumnDiv.className = 'extra-column';
            extraColumnDiv.dataset.columnName = columnName;

            extraColumnDiv.innerHTML = `
                <input type="text" value="${columnName}" readonly>
                <button class="fill-column-button" onclick="fillColumnValues('${columnName}')">Tümüne Uygula</button>
                <button class="delete-extra-column" onclick="deleteExtraColumn(this)">Sütunu Sil</button>
            `;

            extraColumnsContainer.appendChild(extraColumnDiv);

            // Mevcut ürünlere yeni alanı ekle (Mobil)
            const productSections = document.querySelectorAll('.product-section');
            productSections.forEach(section => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.dataset.columnName = columnName;
                formGroup.innerHTML = `
                    <label>${columnName}:</label>
                    <input type="text" placeholder="${columnName} girin">
                `;
                section.insertBefore(formGroup, section.querySelector('.action-button'));
            });

            // Masaüstü için tabloya yeni sütun ekle
            const productTable = document.getElementById('productTable');
            const headerRow = productTable.querySelector('thead tr');
            const newHeader = document.createElement('th');
            newHeader.textContent = columnName;
            newHeader.dataset.columnName = columnName;
            headerRow.insertBefore(newHeader, headerRow.querySelector('.actions-column'));

            // Mevcut satırlara yeni hücre ekle
            const rows = productTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const newCell = row.insertCell(-1);
                newCell.dataset.columnName = columnName;
                newCell.innerHTML = `<input type="text" placeholder="${columnName} girin">`;
                // İşlemler hücresini sona taşı
                const actionsCell = row.querySelector('.actions-cell');
                if (actionsCell) {
                    row.appendChild(actionsCell);
                }
            });
        }

        function deleteExtraColumn(button) {
            const extraColumnDiv = button.parentElement;
            const columnName = extraColumnDiv.dataset.columnName;

            // Ekstra sütunu diziden çıkar
            extraColumns = extraColumns.filter(col => col !== columnName);

            // Ekstra sütunu arayüzden kaldır
            extraColumnDiv.remove();

            // Ürünlerden ilgili alanları kaldır (Mobil)
            const productSections = document.querySelectorAll('.product-section');
            productSections.forEach(section => {
                const formGroup = section.querySelector(`.form-group[data-column-name="${columnName}"]`);
                if (formGroup) {
                    formGroup.remove();
                }
            });

            // Masaüstü için tablodan sütunu kaldır
            const productTable = document.getElementById('productTable');
            const headerCells = productTable.querySelectorAll('thead th');
            let columnIndex = -1;
            headerCells.forEach((th, index) => {
                if (th.dataset.columnName === columnName) {
                    columnIndex = index;
                }
            });

            if (columnIndex !== -1) {
                // Başlıktan kaldır
                headerCells[columnIndex].remove();

                // Satırlardan kaldır
                const rows = productTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    row.deleteCell(columnIndex);
                });
            }
        }

        // Tüm sütuna aynı değeri uygulayan fonksiyon
        function fillColumnValues(columnName) {
            const value = prompt(`Tüm ${columnName} sütunu için değer girin:`);
            if (value !== null) {
                const isMobile = window.matchMedia("(max-width: 600px)").matches;
                if (isMobile) {
                    const productSections = document.querySelectorAll('.product-section');
                    productSections.forEach(section => {
                        const input = section.querySelector(`.form-group[data-column-name="${columnName}"] input`);
                        if (input) {
                            input.value = value;
                        }
                    });
                } else {
                    const headerCells = document.querySelectorAll('#productTable thead th');
                    let columnIndex = -1;
                    headerCells.forEach((th, index) => {
                        if (th.dataset.columnName === columnName) {
                            columnIndex = index;
                        }
                    });
                    if (columnIndex !== -1) {
                        const rows = document.querySelectorAll('#productTable tbody tr');
                        rows.forEach(row => {
                            const cell = row.cells[columnIndex];
                            const input = cell.querySelector('input');
                            if (input) {
                                input.value = value;
                            }
                        });
                    }
                }
            }
        }

        function addProduct() {
            // Mobil için ürün ekleme
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                const productContainer = document.getElementById('productContainer');
                const productCount = productContainer.children.length + 1;

                const productSection = document.createElement('div');
                productSection.className = 'product-section';
                productSection.dataset.index = productCount;

                let extraFieldsHTML = '';
                extraColumns.forEach(columnName => {
                    extraFieldsHTML += `
                        <div class="form-group" data-column-name="${columnName}">
                            <label>${columnName}:</label>
                            <input type="text" placeholder="${columnName} girin">
                        </div>
                    `;
                });

                productSection.innerHTML = `
                    <div class="product-header">
                        <span class="product-number">#${productCount}</span>
                        <div class="reorder-buttons">
                            <button onclick="moveUp(this)">▲</button>
                            <button onclick="moveDown(this)">▼</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ürün İsmi:</label>
                        <input type="text" placeholder="Ürün ismini girin" required>
                    </div>
                    <div class="form-group">
                        <label>Adet:</label>
                        <input type="number" placeholder="Adet girin" required oninput="calculateTotal(this)">
                    </div>
                    <div class="form-group">
                        <label>Birim Fiyatı:</label>
                        <div class="currency-input">
                            <input type="text" placeholder="Birim fiyatını girin" required oninput="calculateTotal(this)">
                            <select onchange="calculateTotal(this)">
                                <option value="EUR">€</option>
                                <option value="TRY">₺</option>
                                <option value="USD">$</option>
                            </select>
                        </div>
                    </div>
                    ${extraFieldsHTML}
                    <div class="form-group">
                        <label>Toplam Fiyat:</label>
                        <input type="text" placeholder="Toplam Fiyat" readonly>
                    </div>
                    <button class="action-button delete-button" onclick="deleteProduct(this)">Ürünü Sil</button>
                `;

                productContainer.appendChild(productSection);
                updateProductNumbers();
            } else {
                // Masaüstü için ürün ekleme
                const productTableBody = document.getElementById('productTable').querySelector('tbody');
                const rowCount = productTableBody.rows.length;
                const row = productTableBody.insertRow();

                row.dataset.index = rowCount + 1;

                let cellIndex = 0;

                // #
                const cellNumber = row.insertCell(cellIndex++);
                cellNumber.textContent = rowCount + 1;

                // Ürün İsmi
                const cellName = row.insertCell(cellIndex++);
                cellName.innerHTML = `<input type="text" placeholder="Ürün ismini girin" required>`;

                // Adet
                const cellQuantity = row.insertCell(cellIndex++);
                cellQuantity.innerHTML = `<input type="number" placeholder="Adet girin" required oninput="calculateTotal(this)">`;

                // Birim Fiyatı
                const cellPrice = row.insertCell(cellIndex++);
                cellPrice.innerHTML = `
                    <div class="currency-input">
                        <input type="text" placeholder="Birim fiyatını girin" required oninput="calculateTotal(this)">
                        <select onchange="calculateTotal(this)">
                            <option value="EUR">€</option>
                            <option value="TRY">₺</option>
                            <option value="USD">$</option>
                        </select>
                    </div>
                `;

                // Toplam Fiyat
                const cellTotal = row.insertCell(cellIndex++);
                cellTotal.innerHTML = `<input type="text" placeholder="Toplam Fiyat" readonly>`;

                // Ekstra sütunlar
                extraColumns.forEach(columnName => {
                    const cell = row.insertCell(cellIndex++);
                    cell.dataset.columnName = columnName;
                    cell.innerHTML = `<input type="text" placeholder="${columnName} girin">`;
                });

                // İşlemler
                const cellActions = row.insertCell(cellIndex++);
                cellActions.className = 'actions-cell';
                cellActions.innerHTML = `
                    <button onclick="moveUp(this)">▲</button>
                    <button onclick="moveDown(this)">▼</button>
                    <button class="delete-button" onclick="deleteProduct(this)">Sil</button>
                `;
            }
        }

        function deleteProduct(button) {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                const productSection = button.closest('.product-section');
                productSection.remove();
                updateProductNumbers();
            } else {
                const row = button.closest('tr');
                row.remove();
                updateProductNumbers();
            }
        }

        function moveUp(button) {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                const productSection = button.closest('.product-section');
                const prevSection = productSection.previousElementSibling;
                if (prevSection) {
                    productSection.parentNode.insertBefore(productSection, prevSection);
                    updateProductNumbers();
                }
            } else {
                const row = button.closest('tr');
                const prevRow = row.previousElementSibling;
                if (prevRow) {
                    row.parentNode.insertBefore(row, prevRow);
                    updateProductNumbers();
                }
            }
        }

        function moveDown(button) {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                const productSection = button.closest('.product-section');
                const nextSection = productSection.nextElementSibling;
                if (nextSection) {
                    productSection.parentNode.insertBefore(nextSection, productSection);
                    updateProductNumbers();
                }
            } else {
                const row = button.closest('tr');
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    row.parentNode.insertBefore(nextRow, row);
                    updateProductNumbers();
                }
            }
        }

        function updateProductNumbers() {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                const productContainer = document.getElementById('productContainer');
                const productSections = productContainer.querySelectorAll('.product-section');
                productSections.forEach((section, index) => {
                    section.dataset.index = index + 1;
                    section.querySelector('.product-number').innerText = `#${index + 1}`;
                });
            } else {
                const productTableBody = document.getElementById('productTable').querySelector('tbody');
                const rows = productTableBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.dataset.index = index + 1;
                    row.cells[0].textContent = index + 1;
                });
            }
        }

        function calculateTotal(element) {
            const isMobile = window.matchMedia("(max-width: 600px)").matches;
            let adetInput, birimFiyatInput, currencySelect, toplamFiyatInput;

            if (isMobile) {
                const productSection = element.closest('.product-section');
                adetInput = productSection.querySelector('input[placeholder="Adet girin"]');
                birimFiyatInput = productSection.querySelector('input[placeholder="Birim fiyatını girin"]');
                currencySelect = productSection.querySelector('.currency-input select');
                toplamFiyatInput = productSection.querySelector('input[placeholder="Toplam Fiyat"]');
            } else {
                const row = element.closest('tr');
                adetInput = row.cells[2].querySelector('input');
                birimFiyatInput = row.cells[3].querySelector('input');
                currencySelect = row.cells[3].querySelector('select');
                toplamFiyatInput = row.cells[4].querySelector('input');
            }

            // Virgülleri noktaya çevir
            birimFiyatInput.value = birimFiyatInput.value.replace(',', '.');

            const adet = parseFloat(adetInput.value) || 0;
            const birimFiyat = parseFloat(birimFiyatInput.value) || 0;
            const currencySign = currencySelect.selectedOptions[0].text;

            const total = adet * birimFiyat;

            toplamFiyatInput.value = currencySign + ' ' + total.toFixed(2);
        }

        // PDF oluşturma fonksiyonları
        async function generatePDF() {
            await createPDF('print');
        }

        async function downloadPDF() {
            await createPDF('download');
        }

        async function sharePDF() {
            await createPDF('share');
        }

        async function createPDF(action) {
            const alici = document.getElementById('alici').value;
            const ilgili = document.getElementById('ilgili').value;
            const gonderen = document.getElementById('gonderen').value;
            const tarih = document.getElementById('tarih').value;
            const teklifNo = document.getElementById('teklifNo').value;
            const genelToplamCurrency = document.getElementById('genelToplamCurrency').value;
            const genelToplamCurrencySign = document.getElementById('genelToplamCurrency').selectedOptions[0].text;

            // Döviz kurlarını al
            await fetchExchangeRates(genelToplamCurrency);

            const isMobile = window.matchMedia("(max-width: 600px)").matches;

            let products = [];
            let genelToplam = 0;

            if (isMobile) {
                const productSections = document.querySelectorAll('.product-section');

                productSections.forEach((section, index) => {
                    const productName = section.querySelector('input[placeholder="Ürün ismini girin"]').value;
                    const adet = parseFloat(section.querySelector('input[placeholder="Adet girin"]').value) || 0;
                    const birimFiyatInput = section.querySelector('input[placeholder="Birim fiyatını girin"]');
                    // Virgülleri noktaya çevir
                    birimFiyatInput.value = birimFiyatInput.value.replace(',', '.');
                    const birimFiyat = parseFloat(birimFiyatInput.value) || 0;
                    const currencySelect = section.querySelector('.currency-input select');
                    const currencySymbol = currencySelect.value;
                    const currencySign = currencySelect.selectedOptions[0].text;
                    const total = adet * birimFiyat;
                    const toplamFiyatText = currencySign + ' ' + total.toFixed(2);

                    // Ekstra alan değerlerini al
                    const extraValues = [];
                    extraColumns.forEach(columnName => {
                        const input = section.querySelector(`.form-group[data-column-name="${columnName}"] input`);
                        const value = input ? input.value : '';
                        extraValues.push({ columnName, value });
                    });

                    // Toplam fiyatı genel toplam para birimine çevir
                    const exchangeRate = exchangeRates[currencySymbol];
                    const convertedTotal = total / exchangeRate;

                    genelToplam += convertedTotal;

                    products.push({
                        index: index + 1,
                        productName,
                        adet,
                        birimFiyat,
                        currencySign,
                        toplamFiyatText,
                        extraValues
                    });
                });
            } else {
                const rows = document.querySelectorAll('#productTable tbody tr');

                rows.forEach((row, index) => {
                    const productName = row.cells[1].querySelector('input').value;
                    const adet = parseFloat(row.cells[2].querySelector('input').value) || 0;
                    const birimFiyatInput = row.cells[3].querySelector('input');
                    // Virgülleri noktaya çevir
                    birimFiyatInput.value = birimFiyatInput.value.replace(',', '.');
                    const birimFiyat = parseFloat(birimFiyatInput.value) || 0;
                    const currencySelect = row.cells[3].querySelector('select');
                    const currencySymbol = currencySelect.value;
                    const currencySign = currencySelect.selectedOptions[0].text;
                    const total = adet * birimFiyat;
                    const toplamFiyatText = currencySign + ' ' + total.toFixed(2);

                    // Ekstra alan değerlerini al
                    const extraValues = [];
                    extraColumns.forEach(columnName => {
                        let cellIndex = -1;
                        const headerCells = document.querySelectorAll('#productTable thead th');
                        headerCells.forEach((th, idx) => {
                            if (th.dataset.columnName === columnName) {
                                cellIndex = idx;
                            }
                        });
                        if (cellIndex !== -1) {
                            const input = row.cells[cellIndex].querySelector('input');
                            const value = input ? input.value : '';
                            extraValues.push({ columnName, value });
                        }
                    });

                    // Toplam fiyatı genel toplam para birimine çevir
                    const exchangeRate = exchangeRates[currencySymbol];
                    const convertedTotal = total / exchangeRate;

                    genelToplam += convertedTotal;

                    products.push({
                        index: index + 1,
                        productName,
                        adet,
                        birimFiyat,
                        currencySign,
                        toplamFiyatText,
                        extraValues
                    });
                });
            }

            // "Alıcı" değerini dosya ismi için hazırlama
            let sanitizedAlici = alici.trim()
                .replace(/[\s]+/g, '-') // Boşlukları tire ile değiştir
                .replace(/[^a-zA-Z0-9ığüşöçİĞÜŞÖÇ\-]/g, '') // Özel karakterleri kaldır, Türkçe karakterleri koru

            // Eğer "Alıcı" alanı boşsa varsayılan bir isim kullan
            if (!sanitizedAlici) {
                sanitizedAlici = 'Fiyat-Teklifi';
            }

            // Dosya ismini oluştur
            const filename = `${sanitizedAlici}-Fiyat-Teklifi-AGEN.pdf`;

            // Tablo sütun genişliklerini ayarla
            const numExtraColumns = extraColumns.length;
            const baseWidth = numExtraColumns > 0 ? 100 : 0;
            const nameColumnWidth = 100 + (3 - numExtraColumns) * 50;

            let content = `
                <div id="pdf-content" style="position: relative; min-height: 1000px;">
                    <div class="pdf-header" style="margin-bottom: 40px; padding: 0 40px;">
                        <img src="logo.svg" class="pdf-logo" style="width: 230px; margin-top: 40px;">
                        <div class="pdf-qr" style="margin-top: 40px;">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?data=http://www.agentedarik.com&size=80x80&color=06AEEF&bgcolor=FFFFFF" alt="QR Code">
                            <div style="color: #0563C1; font-size: 10px;">www.agentedarik.com</div>
                        </div>
                    </div>
                    <!-- Ekstra boşluk -->
                    <div style="height: 40px;"></div>
                    <!-- Bilgiler -->
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #0563C1; padding: 0 40px;">
                        <div>
                            <p><strong>Alıcı:</strong> ${alici}</p>
                            <p><strong>İlgili:</strong> ${ilgili}</p>
                            <p><strong>Gönderen:</strong> ${gonderen}</p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Tarih:</strong> ${tarih}</p>
                            <p><strong>Teklif No:</strong> ${teklifNo}</p>
                        </div>
                    </div>
                    <!-- Boşluk -->
                    <div style="height: 20px;"></div>
                    <!-- Tablo -->
                    <table class="pdf-table" style="width:100%; text-align: left; font-size: 12px; table-layout: fixed; padding: 0 40px;">
                        <thead>
                            <tr>
                                <th style="color: #0563C1; font-weight: bold; width: 30px;">#</th>
                                <th style="color: #0563C1; font-weight: bold; width: ${nameColumnWidth}px;">Tanımı</th>
                                <th style="color: #0563C1; font-weight: bold; width: 60px;">Adet</th>
                                <th style="color: #0563C1; font-weight: bold; width: 100px;">Birim Fiyatı</th>
                                <th style="color: #0563C1; font-weight: bold; width: 100px;">Toplam Fiyat</th>
            `;

            extraColumns.forEach(columnName => {
                content += `<th style="color: #0563C1; font-weight: bold; width: ${baseWidth}px;">${columnName}</th>`;
            });

            content += `
                            </tr>
                        </thead>
                    </table>
                    <!-- Çizgi -->
                    <hr style="border: none; border-top: 2px solid #0563C1; margin: 5px 40px;">
                    <table class="pdf-table" style="width:100%; text-align: left; font-size: 12px; table-layout: fixed; padding: 0 40px;">
                        <tbody>
            `;

            products.forEach(product => {
                content += `
                    <tr>
                        <td style="width: 30px;">${product.index}</td>
                        <td style="width: ${nameColumnWidth}px;">${product.productName}</td>
                        <td style="width: 60px;">${product.adet}</td>
                        <td style="width: 100px;">${product.currencySign} ${parseFloat(product.birimFiyat).toFixed(2)}</td>
                        <td style="width: 100px;">${product.toplamFiyatText}</td>
                `;
                product.extraValues.forEach(extra => {
                    content += `<td style="width: ${baseWidth}px;">${extra.value}</td>`;
                });
                content += `</tr>`;
            });

            content += `
                        </tbody>
                    </table>
                    <!-- Boşluk -->
                    <div style="height: 20px;"></div>
                    <!-- Genel Toplam -->
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px; padding: 0 40px;">
                        <div class="genel-toplam" style="background-color: #0563C1; color: white; padding: 5px; width: 150px; text-align: center; font-size: 14px;">
                            <strong>Genel Toplam</strong><br>
                            <span>${genelToplamCurrencySign} ${genelToplam.toFixed(2)}</span>
                        </div>
                    </div>
                    <!-- Alt bilgi -->
                    <div style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 10px; color: #0563C1;">
                        www.agentedarik.com
                    </div>
                </div>
                <style>
                    /* PDF Stilleri */
                    @page {
                        size: A4;
                        margin: 30mm 20mm 20mm 20mm; /* Üst, sağ, alt, sol boşluklar */
                    }
                    body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; }
                    .pdf-logo { float: left; width: 230px; }
                    .pdf-qr { float: right; text-align: center; }
                    .pdf-qr img { width: 80px; }
                    .pdf-header::after { content: ""; display: block; clear: both; }
                    /* Çizgiler kaldırıldı */
                    .pdf-table, .pdf-table th, .pdf-table td {
                        border: none;
                    }
                    /* Çizgi */
                    hr {
                        border: none;
                        border-top: 2px solid #0563C1;
                    }
                    /* Kelime kaydırma */
                    .pdf-table td, .pdf-table th {
                        word-wrap: break-word;
                    }
                    /* Arka plan renklerinin yazdırılması */
                    @media print {
                        * {
                            -webkit-print-color-adjust: exact;
                            color-adjust: exact;
                            print-color-adjust: exact;
                        }
                    }
                </style>
            `;

            // Resimlerin yüklendiğinden emin ol
            function imagesLoaded() {
                const images = pdfElement.querySelectorAll('img');
                const promises = [];
                images.forEach(img => {
                    if (!img.complete) {
                        promises.push(new Promise(resolve => {
                            img.onload = img.onerror = resolve;
                        }));
                    }
                });
                return Promise.all(promises);
            }

            const pdfElement = document.createElement('div');
            pdfElement.innerHTML = content;
            document.body.appendChild(pdfElement); // Stil uygulanması için body'ye ekle

            await imagesLoaded(); // Resimlerin yüklenmesini bekle

            if (action === 'print') {
                const win = window.open('', '_blank');
                win.document.write(pdfElement.outerHTML);
                win.document.close();
                win.print();
                document.body.removeChild(pdfElement);
            } else if (action === 'download' || action === 'share') {
                const opt = {
                    margin:       [30, 20, 20, 20], // Kenar boşlukları: üst, sol, alt, sağ
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 1 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' }
                };

                if (action === 'download') {
                    html2pdf().set(opt).from(pdfElement).save().then(() => {
                        document.body.removeChild(pdfElement); // Temizlik
                    });
                } else if (action === 'share') {
                    html2pdf().set(opt).from(pdfElement).outputPdf('blob').then(async (pdfBlob) => {
                        document.body.removeChild(pdfElement); // Temizlik

                        const file = new File([pdfBlob], filename, { type: 'application/pdf' });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: 'AGEN Fiyat Teklifi',
                                    text: 'Merhaba, talep etmiş olduğunuz ürünlerin fiyat teklifi ektedir. Kolay gelsin, iyi çalışmalar dilerim.'
                                });
                            } catch (error) {
                                console.error('Paylaşma hatası:', error);
                                alert('Paylaşma işlemi iptal edildi veya bir hata oluştu.');
                            }
                        } else {
                            alert('Paylaşma özelliği bu tarayıcıda desteklenmiyor. Lütfen daha güncel bir tarayıcı kullanınız.');
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>
